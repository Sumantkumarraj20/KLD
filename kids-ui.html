<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåü Kids Stars Dashboard</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #6f42c1;
      --primary-light: #8a6dcc;
      --secondary: #20c997;
      --accent: #ffc107;
      --success: #28a745;
      --danger: #e74c3c;
      --light: #f8f9fa;
      --dark: #343a40;
      --card-bg: #ffffff;
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-success: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      --gradient-accent: linear-gradient(135deg, #ffc107 0%, #ff9e0d 100%);
    }

    body {
      font-family: 'Nunito', 'Comic Neue', sans-serif;
      background: var(--gradient-primary);
      color: var(--dark);
      min-height: 100vh;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--primary-light);
      border-radius: 10px;
    }

    /* Header & Navigation */
    .header-gradient {
      background: var(--gradient-primary);
    }

    .kid-selector-btn {
      transition: all 0.3s ease;
      border: 3px solid transparent;
      min-width: 120px;
    }
    
    .kid-selector-btn.active {
      border-color: var(--accent);
      background: var(--gradient-accent);
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
    }

    /* Cards */
    .dashboard-card {
      background: var(--card-bg);
      border-radius: 20px;
      border: none;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 100%;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }

    /* Profile Section */
    .profile-emoji {
      font-size: 4rem;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }

    .stars-display {
      background: var(--gradient-accent);
      border-radius: 20px;
      padding: 25px;
      color: white;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
      border: 4px solid rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }

    .stars-display::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 1%, transparent 1%);
      background-size: 30px 30px;
      animation: sparkle 4s linear infinite;
    }

    @keyframes sparkle {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stars-count {
      font-size: 3.5rem;
      font-weight: 800;
      line-height: 1;
    }

    /* Progress Bar */
    .progress-goal {
      height: 25px;
      border-radius: 15px;
      background: #e9ecef;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--gradient-success);
      border-radius: 15px;
      position: relative;
      overflow: hidden;
      transition: width 1s cubic-bezier(0.2, 0.9, 0.3, 1);
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    /* Rewards */
    .reward-card {
      border: 3px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .reward-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--secondary);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .reward-card:hover::before {
      transform: scaleX(1);
    }
    
    .reward-card.affordable {
      border-color: var(--secondary);
      background: linear-gradient(135deg, #f0fdfa, #ffffff);
    }
    
    .reward-card.affordable:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(32, 201, 151, 0.2);
    }

    /* Leaderboard */
    .leaderboard-item {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      padding: 12px 0;
    }
    
    .leaderboard-item:last-child {
      border-bottom: none;
    }

    /* Suggestions */
    .suggestion-item {
      border-left: 4px solid var(--accent);
      transition: all 0.2s ease;
    }
    
    .suggestion-item:hover {
      transform: translateX(5px);
      background: var(--light);
    }

    /* Buttons */
    .btn-primary-custom {
      background: var(--gradient-primary);
      border: none;
      color: white;
      font-weight: 600;
    }
    
    .btn-success-custom {
      background: var(--gradient-success);
      border: none;
      color: white;
      font-weight: 600;
    }

    /* Modal */
    .modal-content {
      border-radius: 20px;
      border: none;
    }

    /* Toast */
    .custom-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Audio Button */
    .audio-btn {
      background: transparent;
      border: none;
      color: var(--primary);
      transition: all 0.2s ease;
    }
    
    .audio-btn:hover {
      color: var(--primary-light);
      transform: scale(1.1);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .profile-emoji {
        font-size: 3rem;
      }
      
      .stars-count {
        font-size: 2.5rem;
      }
      
      .kid-selector-btn {
        min-width: 100px;
        padding: 8px 16px;
      }
    }

    @media (max-width: 576px) {
      .kid-selector-btn {
        min-width: 90px;
        font-size: 0.9rem;
      }
      
      .stars-display {
        padding: 15px;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header-gradient text-white py-4">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-3 col-md-2">
          <button class="btn btn-light btn-sm" onclick="goHome()">
            <i class="bi bi-house-door"></i> Home
          </button>
        </div>
        <div class="col-9 col-md-10 text-center text-md-start">
          <h1 class="h2 mb-1 fw-bold">
            üåü Kids Stars Dashboard 
            <button class="audio-btn" onclick="speakText('Kids Stars Dashboard')">
              <i class="bi bi-volume-up"></i>
            </button>
          </h1>
          <p class="mb-0 opacity-75">Collect stars, earn rewards, and have fun!</p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="py-4">
    <div class="container">
      <!-- Kid Selector -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card dashboard-card">
            <div class="card-body">
              <h3 class="h5 mb-3">Choose Your Character:</h3>
              <div id="kidSelector" class="d-flex flex-wrap gap-2 justify-content-center">
                <!-- Kid buttons injected by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading & Error States -->
      <div id="loading" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 text-light fs-5">Loading your stars... ‚ú®</p>
      </div>

      <div id="error" class="alert alert-danger" style="display: none;">
        <h4 class="alert-heading"><i class="bi bi-emoji-frown"></i> Oops! Couldn't Load Data</h4>
        <p>We're having trouble loading your stars and rewards.</p>
        <hr>
        <button class="btn btn-outline-danger" onclick="loadData()">
          <i class="bi bi-arrow-clockwise"></i> Try Again
        </button>
      </div>

      <!-- Dashboard -->
      <div id="dashboardWrap" style="display: none;">
        <div class="row g-4">
          <!-- Left Column -->
          <div class="col-lg-8">
            <!-- Profile Card -->
            <div class="card dashboard-card mb-4">
              <div class="card-body text-center p-4">
                <div id="kidProfileContent">
                  <!-- Injected by JS -->
                </div>
              </div>
            </div>

            <!-- Progress Card -->
            <div class="card dashboard-card mb-4">
              <div class="card-body">
                <div id="progressContent">
                  <!-- Injected by JS -->
                </div>
              </div>
            </div>

            <!-- Rewards Card -->
            <div class="card dashboard-card mb-4">
              <div class="card-body">
                <div id="rewardsContent">
                  <!-- Injected by JS -->
                </div>
              </div>
            </div>

            <!-- Suggestions Card -->
            <div class="card dashboard-card">
              <div class="card-body">
                <h3 class="h5 mb-3">
                  <i class="bi bi-lightbulb"></i> How to Earn More Stars
                  <button class="audio-btn" onclick="speakText('How to earn more stars')">
                    <i class="bi bi-volume-up"></i>
                  </button>
                </h3>
                <div class="list-group list-group-flush">
                  <div class="list-group-item suggestion-item">
                    <div class="d-flex justify-content-between">
                      <span>Help with household chores</span>
                      <span class="badge bg-warning">+5 stars</span>
                    </div>
                  </div>
                  <div class="list-group-item suggestion-item">
                    <div class="d-flex justify-content-between">
                      <span>Complete homework early</span>
                      <span class="badge bg-success">+10 stars</span>
                    </div>
                  </div>
                  <div class="list-group-item suggestion-item">
                    <div class="d-flex justify-content-between">
                      <span>Be kind to siblings</span>
                      <span class="badge bg-info">+8 stars</span>
                    </div>
                  </div>
                  <div class="list-group-item suggestion-item">
                    <div class="d-flex justify-content-between">
                      <span>Read for 20 minutes</span>
                      <span class="badge bg-primary">+7 stars</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column -->
          <div class="col-lg-4">
            <!-- Side Profile Card -->
            <div class="card dashboard-card mb-4">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <div id="sideEmoji" class="fs-1 me-3"></div>
                  <div>
                    <h4 id="sideName" class="h6 mb-0 fw-bold"></h4>
                    <small id="sideNick" class="text-muted"></small>
                  </div>
                </div>
                <div class="stars-display text-center mb-3">
                  <div class="stars-count" id="sideStars">0 ‚≠ê</div>
                  <div class="fw-bold">Shiny Stars</div>
                </div>
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-primary" onclick="showInfo()">
                    <i class="bi bi-question-circle"></i> How it works
                  </button>
                  <button class="btn btn-primary-custom" onclick="openRedeemPanel()">
                    <i class="bi bi-gift"></i> Redeem Rewards
                  </button>
                </div>
              </div>
            </div>

            <!-- Leaderboard Card -->
            <div class="card dashboard-card mb-4">
              <div class="card-body">
                <h3 class="h5 mb-3"><i class="bi bi-trophy"></i> Family Leaderboard</h3>
                <div id="leaderboardList">
                  <!-- Injected by JS -->
                </div>
              </div>
            </div>

            <!-- Daily Bonus Card -->
            <div class="card dashboard-card">
              <div class="card-body text-center">
                <h3 class="h5 mb-3"><i class="bi bi-calendar-check"></i> Daily Bonus</h3>
                <p class="text-muted mb-3">Come back every day for a special reward!</p>
                <button class="btn btn-success-custom btn-lg w-100 mb-2" onclick="claimDaily()" id="dailyBtn">
                  Claim +5 Stars
                </button>
                <div id="dailyMsg" class="small fw-bold"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3">
    <!-- Toasts injected by JS -->
  </div>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8-ZOSGVpkAkUqAR0ErSMvX_o3o7MTPYDBQdoASUJN1qmd3YO40rwoeF2NW1hhgL-E/exec';
    
    // State
    let allKids = [];
    let allRewards = [];
    let currentKid = null;
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;

    // API Client (unchanged from original)
    class KidsPointsAPI {
      constructor(baseUrl) {
        this.baseUrl = baseUrl;
      }

      jsonpRequest(functionName, data = {}) {
        return new Promise((resolve, reject) => {
          const callbackName = `jsonp_callback_${Date.now()}_${Math.random().toString(36).substr(2)}`;
          
          if (window[callbackName]) delete window[callbackName];
          
          const script = document.createElement('script');
          const encodedData = encodeURIComponent(JSON.stringify(data));
          const url = `${this.baseUrl}?callback=${callbackName}&function=${functionName}&data=${encodedData}`;
          
          script.src = url;
          
          window[callbackName] = (response) => {
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            
            if (response && (response.status === 'error' || response.success === false)) {
              reject(new Error(response.message || response.error || 'API error'));
            } else if (response && response.data !== undefined) {
              resolve(response.data);
            } else {
              resolve(response);
            }
          };
          
          script.onerror = (error) => {
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error(`JSONP request failed for ${functionName}`));
          };
          
          document.head.appendChild(script);
          
          setTimeout(() => {
            if (window[callbackName]) {
              delete window[callbackName];
              if (script.parentNode) script.parentNode.removeChild(script);
              reject(new Error(`JSONP request timeout for ${functionName}`));
            }
          }, 15000);
        });
      }

      async getKids() {
        try {
          return await this.jsonpRequest('getKidsAndBalancesForKids');
        } catch (error) {
          console.error('getKids error:', error);
          return [];
        }
      }

      async getRewards() {
        try {
          return await this.jsonpRequest('getRewards');
        } catch (error) {
          console.error('getRewards error:', error);
          return [];
        }
      }

      async redeemReward(data) {
        return this.jsonpRequest('redeemReward', data);
      }

      async claimDailyBonus(data) {
        return this.jsonpRequest('claimDailyBonus', data);
      }
    }

    const api = new KidsPointsAPI(SCRIPT_URL);

    // Core Functions
    function $(id) { return document.getElementById(id); }
    
    function showLoading() {
      $('loading').style.display = 'block';
      $('dashboardWrap').style.display = 'none';
      $('error').style.display = 'none';
    }
    
    function hideLoading() {
      $('loading').style.display = 'none';
    }
    
    function showError(msg) {
      $('error').style.display = 'block';
      $('error').querySelector('p').textContent = msg;
      $('dashboardWrap').style.display = 'none';
      hideLoading();
    }
    
    function showDashboard() {
      $('dashboardWrap').style.display = 'block';
      $('error').style.display = 'none';
      hideLoading();
    }

    // Navigation
    function goHome() {
      window.location.href = '/KLD';
    }

    // Speech Functions
    function speakText(text, rate = 0.9, pitch = 1.1) {
      if (speechSynthesis.speaking) speechSynthesis.cancel();
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = rate;
      utterance.pitch = pitch;
      utterance.volume = 0.8;
      
      const voices = speechSynthesis.getVoices();
      const childVoice = voices.find(voice => 
        voice.name.includes('Child') || 
        voice.name.includes('Kids') ||
        voice.name.includes('Google UK English Female')
      );
      
      if (childVoice) utterance.voice = childVoice;
      speechSynthesis.speak(utterance);
      currentUtterance = utterance;
    }

    function stopSpeech() {
      if (speechSynthesis.speaking) speechSynthesis.cancel();
    }

    // Data Loading
    async function loadData() {
      try {
        showLoading();
        
        const [kidsData, rewardsData] = await Promise.all([
          api.getKids(),
          api.getRewards()
        ]);

        allKids = kidsData || [];
        allRewards = rewardsData || [];

        if (!allKids.length) {
          showError('No kids found. Please ask a parent to set up the spreadsheet.');
          return;
        }

        renderKidSelector();
        currentKid = allKids[0];
        renderDashboard();
        populateLeaderboard();
        showDashboard();
        
        setTimeout(() => checkDailyClaimStatus(), 500);
      } catch(err) {
        showError('Failed to load data: ' + err.message);
      }
    }

    // UI Rendering
    function renderKidSelector() {
      const container = $('kidSelector');
      container.innerHTML = '';
      
      allKids.forEach(kid => {
        const button = document.createElement('button');
        button.className = 'btn btn-outline-primary kid-selector-btn';
        button.innerHTML = `
          <span style="font-size: 1.5rem">${kid.emoji || 'üë§'}</span><br>
          <span>${kid.name.split(' ')[0]}</span>
        `;
        button.onclick = () => selectKid(kid.kid_id);
        container.appendChild(button);
      });
    }

    function selectKid(kidId) {
      const kid = allKids.find(k => k.kid_id === kidId);
      if (!kid) return;
      
      currentKid = kid;
      updateActiveKidButton();
      renderDashboard();
      speakText(`Hello ${kid.name.split(' ')[0]}, you have ${kid.balance} stars!`);
    }

    function updateActiveKidButton() {
      document.querySelectorAll('.kid-selector-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
      });
    }

    function renderDashboard() {
      if (!currentKid) return;
      
      // Update side panel
      $('sideEmoji').textContent = currentKid.emoji || 'üë§';
      $('sideName').textContent = currentKid.name;
      $('sideNick').textContent = currentKid.nickname || '';
      $('sideStars').textContent = `${currentKid.balance} ‚≠ê`;
      
      // Render profile
      renderProfile();
      
      // Render progress
      renderProgress();
      
      // Render rewards
      renderRewards();
    }

    function renderProfile() {
      const container = $('kidProfileContent');
      container.innerHTML = `
        <div class="profile-emoji mb-3">${currentKid.emoji || 'üë§'}</div>
        <h2 class="h3 mb-1 fw-bold">${escapeHtml(currentKid.name)}</h2>
        <p class="text-muted mb-4">"${escapeHtml(currentKid.nickname || 'Super Star')}"</p>
        <div class="stars-display d-inline-block px-5">
          <div class="stars-count">${currentKid.balance} ‚≠ê</div>
          <div class="fw-bold">My Stars Collection</div>
        </div>
        <div class="mt-4">
          <button class="btn btn-outline-primary me-2" onclick="speakText('${currentKid.name} has ${currentKid.balance} stars')">
            <i class="bi bi-volume-up"></i> Read Aloud
          </button>
          <button class="btn btn-outline-secondary" onclick="stopSpeech()">
            <i class="bi bi-stop-circle"></i> Stop
          </button>
        </div>
      `;
    }

    function renderProgress() {
      const target = Number(currentKid.target_balance || 100);
      const balance = Number(currentKid.balance || 0);
      const percentage = target > 0 ? Math.min(Math.round((balance / target) * 100), 100) : 0;
      const needed = Math.max(0, target - balance);
      
      const container = $('progressContent');
      container.innerHTML = `
        <h3 class="h5 mb-3"><i class="bi bi-bullseye"></i> My Progress Goal</h3>
        <div class="progress-goal mb-3">
          <div class="progress-fill" style="width: ${percentage}%"></div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>${balance}</strong> / <strong>${target}</strong> Stars
            ${percentage >= 100 ? '<span class="badge bg-success ms-2">üéâ Goal Achieved!</span>' : ''}
          </div>
          <div>
            ${percentage}% Complete
          </div>
        </div>
        ${percentage < 100 ? `
          <div class="alert alert-info mt-3 mb-0">
            <i class="bi bi-info-circle"></i> You need <strong>${needed}</strong> more stars to reach your goal!
          </div>
        ` : ''}
      `;
    }

    function renderRewards() {
      const balance = Number(currentKid.balance || 0);
      const affordable = allRewards.filter(r => Number(r.points_cost || 0) <= balance);
      const near = allRewards.filter(r => Number(r.points_cost || 0) > balance && Number(r.points_cost || 0) <= balance + 30);
      
      let html = '<h3 class="h5 mb-3"><i class="bi bi-gift"></i> Available Rewards</h3>';
      
      if (affordable.length) {
        html += '<div class="row g-3 mb-4">';
        affordable.forEach(reward => {
          html += `
            <div class="col-md-6">
              <div class="reward-card affordable p-3 rounded-3" onclick="showRedeemModal('${reward.reward_id}')">
                <h5 class="fw-bold mb-2">${escapeHtml(reward.title)}</h5>
                <p class="text-muted small mb-2">${escapeHtml(reward.description || '')}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-success">${reward.points_cost} ‚≠ê</span>
                  <span class="badge bg-success">Available</span>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }
      
      if (near.length) {
        html += '<h6 class="text-muted mb-3">Almost There ‚Äî Keep Going!</h6><div class="row g-3">';
        near.forEach(reward => {
          const needed = reward.points_cost - balance;
          html += `
            <div class="col-md-6">
              <div class="reward-card p-3 rounded-3 border">
                <h5 class="fw-bold mb-2">${escapeHtml(reward.title)}</h5>
                <p class="text-muted small mb-2">${escapeHtml(reward.description || '')}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-primary">${reward.points_cost} ‚≠ê</span>
                  <span class="badge bg-warning">Need ${needed} more</span>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }
      
      if (!affordable.length && !near.length) {
        html = `
          <div class="text-center py-5">
            <div class="display-1 mb-3">üéÅ</div>
            <h4>No Rewards Available Yet</h4>
            <p class="text-muted">Keep earning stars to unlock rewards!</p>
          </div>
        `;
      }
      
      $('rewardsContent').innerHTML = html;
    }

    function populateLeaderboard() {
      const container = $('leaderboardList');
      const sorted = [...allKids].sort((a, b) => b.balance - a.balance);
      
      let html = '';
      sorted.forEach((kid, index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
        html += `
          <div class="leaderboard-item">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <span class="fw-bold me-3">${medal}</span>
                <span class="me-2">${kid.emoji || 'üë§'}</span>
                <div>
                  <div class="fw-bold">${kid.name.split(' ')[0]}</div>
                  <small class="text-muted">${kid.name}</small>
                </div>
              </div>
              <span class="fw-bold text-primary">${kid.balance} ‚≠ê</span>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // Reward Redemption
    async function showRedeemModal(rewardId) {
      const reward = allRewards.find(r => r.reward_id === rewardId);
      if (!reward) return;
      
      const cost = Number(reward.points_cost || 0);
      const balance = Number(currentKid.balance || 0);
      
      if (balance < cost) {
        showToast(`You need ${cost - balance} more stars for this reward!`, 'warning');
        return;
      }
      
      // Create modal with Bootstrap
      const modal = new bootstrap.Modal(document.createElement('div'));
      const modalElement = document.createElement('div');
      modalElement.className = 'modal fade';
      modalElement.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Redeem "${escapeHtml(reward.title)}"</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <div class="display-1 mb-3">üéÅ</div>
              <p>Spend <strong class="text-primary">${cost} ‚≠ê</strong> to get:</p>
              <h4 class="fw-bold mb-3">${escapeHtml(reward.title)}</h4>
              <p class="text-muted">${escapeHtml(reward.description || '')}</p>
              <div class="alert alert-info">
                <div>Your balance: <strong>${balance} ‚≠ê</strong></div>
                <div>After purchase: <strong>${balance - cost} ‚≠ê</strong></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="confirmRedeem">Redeem for ${cost} ‚≠ê</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modalElement);
      modal._element = modalElement;
      
      modalElement.querySelector('#confirmRedeem').onclick = async () => {
        try {
          const result = await api.redeemReward({
            kid_id: currentKid.kid_id,
            kid_name: currentKid.name,
            reward_id: reward.reward_id,
            reward_title: reward.title,
            points_cost: cost
          });
          
          if (result && (result.status === 'success' || result.status === 'ok')) {
            showToast(`üéâ Success! You redeemed "${reward.title}"!`, 'success');
            createConfetti();
            modal.hide();
            setTimeout(() => loadData(), 1000);
          } else {
            throw new Error(result?.message || 'Failed to redeem');
          }
        } catch (error) {
          showToast('Could not redeem: ' + error.message, 'danger');
        }
      };
      
      modal.show();
      
      // Clean up modal after hidden
      modalElement.addEventListener('hidden.bs.modal', () => {
        modalElement.remove();
      });
    }

    // Daily Bonus
    async function claimDaily() {
      const btn = $('dailyBtn');
      const msg = $('dailyMsg');
      
      if (!currentKid || btn.disabled) return;
      
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Claiming...';
      btn.disabled = true;
      
      try {
        const result = await api.claimDailyBonus({
          kid_id: currentKid.kid_id,
          kid_name: currentKid.name
        });
        
        if (result && (result.status === 'success' || result.status === 'ok')) {
          btn.innerHTML = '<i class="bi bi-check-circle"></i> Claimed Today';
          msg.innerHTML = '<span class="text-success">+5 stars added! ‚ú®</span>';
          showToast('Daily bonus claimed! +5 stars üéâ', 'success');
          createConfetti();
          setTimeout(() => loadData(), 1500);
        } else if (result && result.alreadyClaimed) {
          btn.innerHTML = '<i class="bi bi-check-circle"></i> Claimed Today';
          msg.innerHTML = '<span class="text-warning">Already claimed! Come back tomorrow üåü</span>';
          showToast('Already claimed your daily bonus!', 'info');
        } else {
          throw new Error(result?.message || 'Claim failed');
        }
      } catch (error) {
        btn.innerHTML = originalText;
        btn.disabled = false;
        showToast('Claim failed. Please try again!', 'danger');
      }
    }

    async function checkDailyClaimStatus() {
      try {
        const result = await api.claimDailyBonus({ 
          kid_id: currentKid.kid_id, 
          kid_name: currentKid.name,
          checkOnly: true 
        });
        
        const btn = $('dailyBtn');
        const msg = $('dailyMsg');
        
        if (result && result.alreadyClaimed) {
          btn.disabled = true;
          btn.innerHTML = '<i class="bi bi-check-circle"></i> Claimed Today';
          msg.innerHTML = '<span class="text-warning">Come back tomorrow! üåü</span>';
        }
      } catch (error) {
        // Silent fail - non-critical
      }
    }

    // Utility Functions
    function showToast(message, type = 'success') {
      const container = $('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.id = toastId;
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      container.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    function createConfetti() {
      const colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#6A0572', '#118AB2', '#51cf66'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            border-radius: 2px;
            z-index: 9999;
            pointer-events: none;
            left: ${Math.random() * 100}vw;
            top: -20px;
          `;
          
          document.body.appendChild(confetti);
          
          confetti.animate([
            { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
            { transform: `translateY(${window.innerHeight + 100}px) rotate(${360 + Math.random() * 360}deg)`, opacity: 0 }
          ], {
            duration: 3000 + Math.random() * 2000,
            easing: 'cubic-bezier(0.1,0.8,0.3,1)'
          });
          
          setTimeout(() => confetti.remove(), 5000);
        }, i * 50);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // Public API
    window.loadData = loadData;
    window.selectKid = selectKid;
    window.speakText = speakText;
    window.stopSpeech = stopSpeech;
    window.claimDaily = claimDaily;
    
    window.showInfo = () => {
      const modal = new bootstrap.Modal(document.createElement('div'));
      const modalElement = document.createElement('div');
      modalElement.className = 'modal fade';
      modalElement.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">How Stars Work üåü</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-info">
                <i class="bi bi-star-fill"></i> <strong>Earn stars</strong> by helping around the house, being kind, and completing tasks!
              </div>
              <div class="alert alert-success">
                <i class="bi bi-gift-fill"></i> <strong>Use your stars</strong> to redeem awesome rewards. Parents will approve your requests.
              </div>
              <div class="alert alert-warning">
                <i class="bi bi-calendar-heart"></i> <strong>Daily bonus</strong> - come back every day for extra stars!
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modalElement);
      modal._element = modalElement;
      modal.show();
      
      modalElement.addEventListener('hidden.bs.modal', () => {
        modalElement.remove();
      });
    };
    
    window.openRedeemPanel = () => {
      const affordable = allRewards.filter(r => Number(r.points_cost || 0) <= Number(currentKid.balance || 0));
      if (affordable.length === 0) {
        showToast('You need more stars to redeem rewards! üí´', 'warning');
        return;
      }
      showToast(`You have ${currentKid.balance} stars available! Click any reward to redeem.`, 'info');
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', loadData);
    speechSynthesis.onvoiceschanged = () => {
      console.log('Speech voices loaded:', speechSynthesis.getVoices().length);
    };
  </script>
</body>
</html>
